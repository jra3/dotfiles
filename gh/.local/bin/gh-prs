#!/bin/bash
# gh prs - List PRs with status and CI info (colored, clickable)
# PR colors: grey=draft, green=approved, yellow=pending review, magenta=changes requested, red=conflicts
# PR numbers and Linear issue IDs are clickable (OSC 8 hyperlinks) - Ctrl+click to open in browser
#
# Usage: gh prs [--watch [SECONDS]]
#   --watch         Refresh every 15 seconds (default)
#   --watch N       Refresh every N seconds

WATCH=0
INTERVAL=15

# Debug: uncomment to see args
# echo "DEBUG: args=[$*] count=$#" >&2

while [[ $# -gt 0 ]]; do
  case $1 in
    --watch|-w)
      WATCH=1
      if [[ $2 =~ ^[0-9]+$ ]]; then
        INTERVAL=$2
        shift
      fi
      shift
      ;;
    *)
      shift
      ;;
  esac
done

fetch_prs() {
  local REPO_URL TERM_WIDTH TITLE_WIDTH
  REPO_URL=$(gh repo view --json url -q .url)
  TERM_WIDTH=$(tput cols 2>/dev/null || echo 120)
  # Fixed columns: PR(6) + sep(2) + LINEAR(9) + sep(2) + CI(8) + sep(2) = 29
  TITLE_WIDTH=$((TERM_WIDTH - 29))
  [[ $TITLE_WIDTH -lt 20 ]] && TITLE_WIDTH=20

  gh pr list --author @me --state open --json number,title,isDraft,reviewDecision,mergeable,statusCheckRollup,headRefName | \
    jq -r '.[] | [
      (.number | tostring),
      (if .isDraft then "draft"
       elif .mergeable == "CONFLICTING" then "conflict"
       elif .reviewDecision == "CHANGES_REQUESTED" then "changes"
       elif .reviewDecision == "APPROVED" then "approved"
       else "pending" end),
      (if .statusCheckRollup == null or .statusCheckRollup == [] then "pending"
       else (.statusCheckRollup |
         if any(.status == "IN_PROGRESS" or .status == "QUEUED" or .status == "PENDING") then "running"
         elif any(.conclusion == "FAILURE" or .conclusion == "failure") then "fail"
         else "pass" end) end),
      # Extract Linear issue ID from branch name (e.g., "john/eng-123-foo" -> "ENG-123")
      (.headRefName | capture("(?<team>[a-zA-Z]+)-(?<num>[0-9]+)") | "\(.team | ascii_upcase)-\(.num)" // ""),
      .title
    ] | @tsv' | \
    awk -F'\t' -v repo="$REPO_URL" -v title_width="$TITLE_WIDTH" '
      BEGIN {
        printf "%-6s  %-9s  %-8s  %s\n", "PR", "LINEAR", "CI", "TITLE"
        printf "%-6s  %-9s  %-8s  %s\n", "------", "---------", "--------", "-----"
      }
      {
        # Pad visible text BEFORE adding escape codes (printf counts escapes as chars)
        pr_text = sprintf("%-6s", "#" $1)
        linear_text = sprintf("%-9s", $4 != "" ? $4 : "-")
        ci_text = sprintf("%-8s", $3)

        # Truncate title to available width
        title = substr($5, 1, title_width)

        # OSC 8 hyperlink: \033]8;;URL\033\\TEXT\033]8;;\033\\
        url = repo "/pull/" $1
        link_start = "\033]8;;" url "\033\\"
        link_end = "\033]8;;\033\\"

        # Color PR number based on status (with clickable link)
        if ($2 == "draft") pr = link_start "\033[90m" pr_text "\033[0m" link_end
        else if ($2 == "approved") pr = link_start "\033[32m" pr_text "\033[0m" link_end
        else if ($2 == "pending") pr = link_start "\033[33m" pr_text "\033[0m" link_end
        else if ($2 == "changes") pr = link_start "\033[35m" pr_text "\033[0m" link_end
        else if ($2 == "conflict") pr = link_start "\033[31m" pr_text "\033[0m" link_end
        else pr = link_start pr_text link_end

        # Color CI status
        if (ci_text ~ /pass/) ci = "\033[32m" ci_text "\033[0m"
        else if (ci_text ~ /fail/) ci = "\033[31m" ci_text "\033[0m"
        else ci = "\033[33m" ci_text "\033[0m"

        # Linear issue as clickable hyperlink
        if ($4 != "") {
          linear_url = "https://linear.app/antimetal/issue/" $4
          linear = "\033]8;;" linear_url "\033\\\033[36m" linear_text "\033[0m\033]8;;\033\\"
        } else {
          linear = "\033[90m" linear_text "\033[0m"
        }

        printf "%s  %s  %s  %s\n", pr, linear, ci, title
      }'
}

if [[ $WATCH -eq 1 ]]; then
  trap 'exit 0' INT
  tput civis  # hide cursor
  trap 'tput cnorm; exit 0' INT  # restore cursor on exit
  while true; do
    output=$(fetch_prs)
    # Move to home position (no clear), overwrite in place
    echo -e "\033[H\033[90m[$(date +%H:%M:%S)] Refreshing every ${INTERVAL}s - Ctrl+C to stop\033[0m"
    echo
    echo "$output"
    echo -e "\033[J"  # clear from cursor to end of screen (removes stale lines)
    sleep "$INTERVAL"
  done
else
  fetch_prs
fi
